<div class="analysis right-side">
  <div class="page">
    <h2>who are people talking about?</h2>
    <ul id="users">
		<!-- <li><img src="http://a0.twimg.com/profile_images/1399208454/Kibbe4_normal.jpg" /><span>Richard Caudle (10)</span><div style="width: 70%"></div></li>
		<li><img src="http://a0.twimg.com/profile_images/1399208454/Kibbe4_normal.jpg" /><span>Richard Caudle (10)</span><div style="width: 60%"></div></li>
		<li><img src="http://a0.twimg.com/profile_images/1399208454/Kibbe4_normal.jpg" /><span>Richard Caudle (10)</span><div style="width: 50%"></div></li>
		<li><img src="http://a0.twimg.com/profile_images/1399208454/Kibbe4_normal.jpg" /><span>Richard Caudle (10)</span><div style="width: 40%"></div></li>
		<li><img src="http://a0.twimg.com/profile_images/1399208454/Kibbe4_normal.jpg" /><span>Richard Caudle (10)</span><div style="width: 30%"></div></li>
		<li><img src="http://a0.twimg.com/profile_images/1399208454/Kibbe4_normal.jpg" /><span>Richard Caudle (10)</span><div style="width: 20%"></div></li>
		<li><img src="http://a0.twimg.com/profile_images/1399208454/Kibbe4_normal.jpg" /><span>Richard Caudle (10)</span><div style="width: 20%"></div></li>
		 -->
    </ul>
  </div>
</div>

<script src="http://js.pusher.com/1.12/pusher.min.js"></script>
<script src="http://d3js.org/d3.v2.js"></script>

<script>

	var usersList = $('#users');
	var usersColourList = d3.scale.category20b().range();

	Pusher.log = function( msg ) {
		if( window.console && window.console.log ) {
			window.console.log( msg );
		}
	};

	$(document).ready(function() {


		// establish Pusher connection
		var pusher = new Pusher('<%= @app_key %>', { encrypted: true });

		var usersChannel = pusher.subscribe('topic-trends-users');

		usersChannel.bind('new-data', function(data) {
			updateUsers(data);
		});

	});

	function updateUsers(data)
	{
		usersList.hide();
		usersList.empty();

		// Calculate max value
		var maxTotal = 0;

		$.each(data, function(index, value) {
			if(value.total > maxTotal) maxTotal = value.total;
		});

		$.each(data, function(index, value) {
			if(index < 7)
			{
				var endWidth = value.total / maxTotal * 90;

				usersList.append('<li><img src="' + value.image_url + '" /><span>'  + value.name + ' (@' + value.source_name + ')' + '</span><div style="background-color:' + usersColourList[index * 3] + '"></div></li>');

				$('#users li div:last').delay(300 + index * 100).animate({
    				width: endWidth + '%'
  					}, 300);
			}
		});

		usersList.slideDown(300);
		
	}

</script>
